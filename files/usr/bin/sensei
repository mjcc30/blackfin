#!/usr/bin/env bash

# Configuration
CONFIG_DIR="$HOME/.config/blackfin"
KEY_FILE="$CONFIG_DIR/sensei_key"
API_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent"

# Couleurs
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# System Prompt : La personnalitÃ© du Mentor
SYSTEM_PROMPT="You are Sensei, the AI Mentor built into Blackfin OS (a Fedora-based cybersecurity distro). 
Your goal is to teach the user about cybersecurity, penetration testing, OSINT, and Linux command line.
RULES:
1. Be pedagogical but technical. Explain 'Why' before showing 'How'.
2. Prioritize tools available in Blackfin (Exegol, Nmap, Metasploit, Docker, Podman, Just).
3. Be ethical. Always warn about legality when discussing offensive tools.
4. Format your response in Markdown. Use code blocks for commands.
5. Keep it concise. The user is in a terminal.
6. If asked about Blackfin specific commands, recall: 'just ghost-shell', 'just stealth-mode-on', 'exegol', 'distrobox'.
User Query:"

# 1. VÃ©rification / CrÃ©ation de la ClÃ© API
if [ ! -f "$KEY_FILE" ]; then
    echo -e "${CYAN}ðŸ¦ˆ Welcome to Sensei, your AI Cyber Mentor.${NC}"
    echo "To function, I need a Google Gemini API Key (It's free)."
    echo "Get one here: https://aistudio.google.com/app/apikey"
    echo ""
    read -p "Paste your API Key here: " USER_KEY
    
    if [ -z "$USER_KEY" ]; then
        echo -e "${RED}No key provided. Sensei cannot start.${NC}"
        exit 1
    fi

    mkdir -p "$CONFIG_DIR"
    echo "$USER_KEY" > "$KEY_FILE"
    chmod 600 "$KEY_FILE"
    echo -e "${GREEN}Key saved! You can now use 'sensei <question>'${NC}"
    echo ""
fi

API_KEY=$(cat "$KEY_FILE")

# 2. Gestion de l'argument (La question)
QUESTION="$*"

if [ -z "$QUESTION" ]; then
    echo "Usage: sensei <your question>"
    echo "Example: sensei how do I scan a network stealthily?"
    exit 0
fi

# 3. Construction du JSON
# On Ã©chappe les guillemets pour Ã©viter de casser le JSON
SAFE_QUESTION=$(echo "$QUESTION" | sed 's/"/\\"/g')
FULL_PROMPT="$SYSTEM_PROMPT $SAFE_QUESTION"

JSON_DATA=$(jq -n \
                  --arg text "$FULL_PROMPT" \
                  '{contents: [{parts: [{text: $text}]}]}')

# 4. Appel API
echo -e "${CYAN}ðŸ§  Sensei is thinking...${NC}"

RESPONSE=$(curl -s -H "Content-Type: application/json" \
     -d "$JSON_DATA" \
     "${API_URL}?key=${API_KEY}")

# 5. Traitement de la rÃ©ponse
# On vÃ©rifie si on a une erreur
ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')

if [ -n "$ERROR" ]; then
    echo -e "${RED}Sensei Error:${NC} $ERROR"
    echo "Check your API key in $KEY_FILE"
    exit 1
fi

# Extraction du texte
TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

# 6. Affichage (avec Glow si dispo, sinon cat)
echo ""
if command -v glow &> /dev/null; then
    echo "$TEXT" | glow - 
else
    echo -e "$TEXT"
fi
echo ""
